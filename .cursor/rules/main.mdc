---
description: RDance Project Rules
globs:
alwaysApply: true
---

Данный файл описывает проект и содержит всю необходимую для разработки информацию о проекте.
Данный файл является источником истины о проекте. При наличии расхождений между этим файлом и проектом, для принятия решений используется информация в этом файле.
Анализировать код для понимания состояния проекта нельзя. Вся необходимая информация о проекте, для решения поставленной задачи указана в этом файле начиная с раздела "Контекст проекта". Если после заголовка раздела "Контекст проекта" ничего нет - значит проект новый и не содержит файлов.
При разработке проекта обязательно выполнять все пункты из раздела "Правила и указания".

# Правила и указания

- Проверять код на наличие ошибок не нужно. Запускать установку модулей не нужно.
- Перед тем как решать задачу, тебе нужна информация о проекте. Требуемая информация указана в этом файле начиная с раздела "Контекст проекта". Если раздел пустой, значит проект новый и не содержит файлов.
- После решения задачи, отредактируй этот файл начиная с раздела "Контекст проекта" так, чтобы он содержал всю необходимую информацию для тебя, чтобы ты мог без текушего контекста решать следующие задачи без анализа файлов проекта, основываясь только на информации в разделе "Контекст проекта". Информацию нужно записать в текстовом виде удобном для тебя, а не для человека. Если некоторая содержащаяся в этом разделе информация неактуальна - ее следует удалить.
- Выполняя задачу, важно делать только то, что указано в задаче. Если есть предположения о том, что можно сделать помимо описанных требований, необходимо спросить - нужно ли это делать перед тем как делать.
- Если поставленная задача содержит слова, термины, формулировки, которые можно понять двояко, необходимо уточнить, что конкретно имеется ввиду.
- Если поставленную задачу можно сделать разными способами, с одинаковым качеством, необходимо задать уточняюшщие вопросы и, основываясь на ответах, выбрать наилучший.

# ВАЖНО: Обновлять файл .cursor/rules/main.mdc после выполнения. Единственный файл со словесным описанием, который можно изменять, это файл .cursor/rules/main.mdc

# ВАЖНО: Не запускать npm start без отдельного указания, не запускать другой сервер для проверки, без отдельного указания

# ВАЖНО: Стэк проекта
Проект реализуется на языке TypeScript с включенным режимом strict. При установке библиотек обязательно требуется установить библиотеки с типами. 
Для разработки backend используется NodeJS и фреймворк Nest для API, PostgreSQL, работа с которой осуществляется через ORM Sequelize. Пользователи авторизуются с помощью jwt, пароли шифруются с помощью bcrypt. Разработка ведется на TypeScript с включенным режимом strict.
Для разработки frontend используются React, react-router, vite. Разработка ведется на TypeScript с включенным режимом strict

# Контекст проекта

## Название проекта
The Last of Guss - игра-кликер с бэкенд и фронтэнд частями

## Текущее состояние
Создана полная система игры-кликера с бэкенд и фронтенд частями:
- Backend: NestJS + TypeScript + Sequelize + PostgreSQL с полным JSON API
- Frontend: React + TypeScript + Vite с авторизацией и отображением раундов

## Структура проекта
- contract/ - общие типы данных для API (TypeScript пакет)
  - src/
    - models.ts - базовые модели данных (User, Round, Score)
    - requests.ts - типы запросов к API (AuthRequest, TapRequest, CreateRoundRequest)
    - responses.ts - типы ответов от API (AuthResponse, TapResponse, RoundsResponse, RoundResponse, RoundWithResultsResponse, CreateRoundResponse, ApiError)
    - index.ts - экспорт всех типов и константы API_ENDPOINTS
  - package.json - зависимости и скрипты TypeScript пакета
  - tsconfig.json - конфигурация TypeScript для пакета
  - dist/ - скомпилированные типы и декларации

- server/ - бэкенд часть на NestJS
  - src/
    - models/ - модели Sequelize (User, Round, Score)
    - database/ - конфигурация и сервис базы данных
    - auth/ - модуль аутентификации (AuthModule, AuthService, AuthController, JwtStrategy)
    - games/ - модуль игровых эндпоинтов (GamesModule, GamesService, GamesController)
    - app.module.ts - основной модуль приложения
    - main.ts - точка входа
  - package.json - зависимости и скрипты (включает @roundsquares/contract)
  - tsconfig.json - конфигурация TypeScript
  - env.example - пример конфигурации окружения

- client/ - фронтенд часть на React
  - src/
    - types/ - TypeScript типы для API (re-export из @roundsquares/contract + дополнительные типы)
    - services/ - сервис для работы с API
    - pages/ - страницы приложения (AuthPage, HomePage, RoundPage)
    - components/ - компоненты (ProtectedRoute)
    - assets/ - изображения игры (guss_ready.png, guss_stop.png, guss_tapped.png)
    - App.tsx - основное приложение с роутингом
    - main.tsx - точка входа
  - package.json - зависимости и скрипты (включает @roundsquares/contract)
  - vite.config.ts - конфигурация Vite
  - .env.example - пример конфигурации окружения

## Модели базы данных
1. **users** - пользователи системы
   - login (string, primary key) - логин пользователя
   - password_hash (string) - хеш пароля
   - role (string) - роль пользователя (user/admin/nikita)

2. **rounds** - раунды игры
   - uuid (UUID, primary key) - уникальный идентификатор раунда
   - start_datetime (Date) - время начала раунда
   - end_datetime (Date) - время окончания раунда
   - status (string) - статус раунда
   - score (integer) - общий счет раунда

3. **scores** - счета пользователей в раундах
   - user (string, foreign key) - ссылка на пользователя
   - round (UUID, foreign key) - ссылка на раунд
   - score (integer) - счет пользователя в раунде
   - taps (integer) - количество тапов пользователя в раунде
   - Уникальное ограничение: комбинация (user, round) должна быть уникальной

## Начальные пользователи
- roma / roma (role: user)
- alisa / alisa (role: user)  
- admin / admin (role: admin)

## API Эндпоинты
1. **POST /auth** - аутентификация пользователя
   - Входные данные: { username: string, password: string }
   - Возвращает: { access_token: string } при успешной аутентификации
   - Логика авторизации:
     - Если пользователь существует: проверяется пароль, возвращается токен при совпадении
     - Если пользователь не существует: создается новый пользователь с указанным именем и паролем
     - Роли новых пользователей: "nikita" для пользователя "Никита", "user" для всех остальных
   - Возвращает ошибку 401 только при неверном пароле для существующего пользователя

2. **GET /rounds** - получение всех раундов
   - Требует JWT токен в заголовке Authorization: Bearer <token>
   - Возвращает массив всех раундов из таблицы rounds

3. **GET /round/:uuid** - получение конкретного раунда и счета пользователя
   - Требует JWT токен в заголовке Authorization: Bearer <token>
   - Возвращает: { round: Round, score: Score }
   - Автоматически создает запись в таблице scores для пользователя и раунда, если такой записи еще нет
   - score содержит счет пользователя из токена для указанного раунда (всегда возвращает объект Score, не null)
   - Если раунд завершен, дополнительно возвращает:
     - totalScore: number - общая сумма всех игроков в раунде
     - bestPlayer: { username: string, score: number } | null - лучший игрок и его счет
     - currentUserScore: number - счет текущего пользователя

4. **POST /tap** - выполнение клика
   - Требует JWT токен в заголовке Authorization: Bearer <token>
   - Входные данные: { uuid: string } - UUID раунда
   - Возвращает ошибку 400 если uuid не указан
   - Выполняет транзакционную логику:
     - Находит или создает запись в таблице scores для пользователя и раунда
     - Увеличивает taps на 1
     - Вычисляет новый score по формуле: Math.floor(taps/11)*9 + taps
     - Обновляет запись в таблице scores
     - Увеличивает общий счет раунда в таблице rounds на величину увеличения score
   - Возвращает: { message: "tap performed", score: number } - текущий счет пользователя после тапа

5. **POST /round** - создание нового раунда (только для админов)
   - Требует JWT токен в заголовке Authorization: Bearer <token>
   - Проверяет роль пользователя - только admin может создавать раунды
   - Возвращает ошибку 403 если роль не admin
   - Создает раунд с start_datetime = текущее время + COOLDOWN_DURATION секунд
   - end_datetime = текущее время + COOLDOWN_DURATION + ROUND_DURATION секунд
   - Возвращает созданный объект Round

## Переменные окружения
- DB_URI - строка подключения к PostgreSQL
- PORT - порт сервера (по умолчанию 3000)
- JWT_SECRET - секретный ключ для JWT токенов
- COOLDOWN_DURATION - время ожидания до начала раунда в секундах (по умолчанию 60)
- ROUND_DURATION - длительность раунда в секундах (по умолчанию 300)

## Функциональность
- Автоматическое подключение к PostgreSQL при запуске
- Проверка существования таблицы users
- Автоматическая инициализация базы данных при первом запуске
- Создание всех необходимых таблиц
- Создание начальных пользователей с хешированными паролями
- JWT аутентификация с проверкой токенов и ролей пользователей
- Автоматическое создание новых пользователей при авторизации несуществующих пользователей
- Специальная роль "nikita" для пользователя "Никита"
- Защищенные эндпоинты с проверкой авторизации
- Создание раундов только для пользователей с ролью admin
- Автоматический расчет времени начала и окончания раундов на основе переменных окружения

## Функциональность фронтенда
- Авторизация пользователей через форму логина/пароля
- Защищенные маршруты с проверкой JWT токена
- Отображение списка всех раундов в табличном виде с возможностью клика для перехода к раунду
- Страница раунда с полной функциональностью игры:
  - Отображение информации о раунде (время начала/окончания, статус)
  - Обратный отсчет до начала раунда с картинкой guss_stop.png
  - Активный режим игры с картинкой guss_ready.png и возможностью тапа
  - Визуальная обратная связь при тапе (картинка guss_tapped.png)
  - Отправка POST /tap запросов с uuid раунда при каждом тапе
  - Получение текущего счета от сервера в ответе на тап
  - Обновление отображаемого счета только если сервер вернул больше очков
  - Отображение текущего счета пользователя
  - При завершении раунда отображение результатов:
    - Общий счет раунда (сумма всех игроков)
    - Имя и счет лучшего игрока
    - Счет текущего пользователя
  - Автоматическое обновление страницы через 3 секунды после завершения раунда
- Автоматическое перенаправление на страницу авторизации при отсутствии токена
- Сохранение токена в localStorage
- Декодирование JWT токена для получения роли пользователя
- Кнопка "Создать раунд" отображается только для пользователей с ролью admin
- Создание раундов через API с обработкой ошибок
- Автоматическое обновление списка раундов после создания нового
- Обработка ошибок API и отображение пользователю
- Адаптивный дизайн с современным UI

## Технологический стек
- Contract: TypeScript пакет с общими типами для API (@roundsquares/contract)
- Backend: NestJS, TypeScript (strict mode), Sequelize, PostgreSQL, bcrypt, JWT, Passport, uuid
- Frontend: React, TypeScript (strict mode), Vite, react-router-dom

## Запуск
- Contract: cd contract && npm run build - сборка типов
- Server: cd server && npm run start:dev - режим разработки бэкенда
- Client: cd client && npm run dev - режим разработки фронтенда
- Server prod: cd server && npm run build && npm run start:prod - продакшен бэкенда
- Client prod: cd client && npm run build - сборка фронтенда для продакшена


